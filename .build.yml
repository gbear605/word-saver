image: ubuntu/lts
packages:
  - npm
  - jq
sources:
  - https://git.sr.ht/~gbear605/word-saver
secrets:
  - ecfd2bcd-aa06-44cb-8e3f-068751a71ce6
  - 9ec2af9f-3ed8-4c2f-b02c-53d0daee8fe6
  - 0755116a-2598-41d7-b910-e8d6d97410b3
tasks:
  - setup: |
      sudo npm config set progress=false
      sudo npm install --global web-ext || true
  - build: |
      cd word-saver
      web-ext lint
      web-ext build
  - deploy: |
      cd word-saver
      if [[ $(git branch --show-current) = main ]]
      then
        set +x 
        web-ext sign --api-key $(cat ~/jwt_issuer) --api-secret $(cat  ~/jwt_secret)
        set -x
        scp -o "StrictHostKeyChecking=no" ./web-ext-artifacts/word_saver-$(jq -r .version manifest.json).zip root@greenwichmeanti.me:/var/www/greenwichmeanti.me/public_html/wordsaver
        scp -o "StrictHostKeyChecking=no" ./web-ext-artifacts/word_saver-$(jq -r .version manifest.json)-an+fx.xpi root@greenwichmeanti.me:/var/www/greenwichmeanti.me/public_html/wordsaver
      fi